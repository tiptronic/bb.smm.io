<!DOCTYPE HTML>
<html>

<head>
    <title>Bürgerbus Bad Bevensen</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@latest/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script src="https://kit.fontawesome.com/fd25864f74.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
    <script src="mqtt.js"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html,
        body,
        #mapid {
            height: 100vh;
            width: 100vw;
        }
    </style>

</head>

<body>
    <div style="height: 800px; width:auto" id="map"></div>

    <script>
        // https://blog.astrid-guenther.de/routing-und-geocoding-leaflet/
        // https://marburg-biedenkopf-mobil.de/toolbox/
        // https://wiki.openstreetmap.org/wiki/Proposal:Refined_Public_Transport
        //  https://www.liedman.net/leaflet-control-geocoder/docs/
        // https://github.com/perliedman/leaflet-routing-machine

        const lat = 53.0805;
        const lng = 10.5700;


        // Layer mit den unterschiedlichen Kartenansichten deklarieren:



        // OSM Mapnik
        const osmMap = L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
            maxZoom: 20,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });
        // - Thunderforest Fahrradkarte
        // cycleMap = L.tileLayer('https://{s}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png?apikey=<dein Schlüssel>',
        //     { attribution: '&copy; <a href="https://openstreetmap.org">OpenStreetMap</a> Contributors &copy; <a href="https://thunderforest.com/">Thunderforest</a>"' }),

        // - ÖPNV-Karte
        const opnv = new L.tileLayer('http://tile.memomaps.de/tilegen/{z}/{x}/{y}.png', {
            minZoom: 3,
            maxZoom: 20,
            attribution: 'Map data &copy; <a href="http://memomaps.de/">ÖPNV Karte</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
        });

        const defaultMap = osmMap;
        const apiToken = 'pk.eyJ1IjoidGlwdHJvbmljIiwiYSI6ImNsamZvNWsyeTAyYzEzYm42M2kzb2xuNWgifQ._qJ0ZfLoaFY16tkn5YZeiw';
        const fontawesomeToken = 'fd25864f74';

        // Kartenobjekt mit Kartenmittelpunkt. Hier 52.44338, 13.33057
        // OSM Straßenansicht ist Standardansicht

        // var landkarte = L.map('landkarte', { layers: [osmMap] }) // Nur ein Layer angeben!
        //     .setView([52.4433752, 13.3301968], 13);

        var map = L.map('map', { layers: [ defaultMap ] }).setView([ lat, lng ], 16);

        var busIcon = L.icon({
            iconUrl: 'busicon.png',
            shadowUrl: 'marker-shadow.png',

            iconSize: [ 25, 41 ], // size of the icon
            shadowSize: [ 41, 41 ], // size of the shadow
            iconAnchor: [ 22, 94 ], // point of the icon which will correspond to marker's location
            // shadowAnchor: [ 4, 62 ],  // the same for the shadow
            popupAnchor: [ -3, -76 ] // point from which the popup should open relative to the iconAnchor
        });

        var theMarker = {};

        map.on('click', function(e) {
            const clat = e.latlng.lat;
            const clon = e.latlng.lng;

            console.log("You clicked the map at LAT: " + clat + " and LONG: " + clon);
            //Clear existing marker, 

            if(theMarker != undefined) {
                map.removeLayer(theMarker);
            };

            //Add a marker to show where you clicked.
            // L.marker([51.5, -0.09], {icon: greenIcon}).addTo(map);
            theMarker = L.marker([ clat, clon ], {icon: busIcon}).addTo(map);
        });

        // Basislayer für die Layerkontrolle

        var baseLayers = {
            "Straßenkarte": osmMap,
            // "Fahrrad": cycleMap,
            "ÖPNV": opnv
        };

        // Umschalter für die unterschiedlichen Kartenlayer

        L.control.layers(baseLayers).addTo(map);

        /* owntracks */
        const owntracks_position_default = {
            "_type": "location",
            "acc": 6,
            "alt": 37,
            "batt": 69,
            "bs": 1,
            "BSSID": "c:72:74:8b:26:38",
            "conn": "w",
            "created_at": 1689534185,
            "lat": 53.080514,
            "lon": 10.570026,
            "m": 0,
            "p": 100.972,
            "SSID": "Bunda",
            "t": "u",
            "tid": "iX",
            "tst": 1689534182,
            "vac": 14
        };




        // var geojsonFeature = {
        //     "type": "Feature",
        //     "properties": {
        //         "name": "from",
        //         "type": "from",
        //         "amenity": "Baseball Stadium",
        //         "popupContent": "This is where the Rockies play!"
        //     },
        //     "geometry": {
        //         "type": "Point",
        //         "coordinates": [
        //             10.578343,
        //             53.079616
        //         ]
        //     }
        // };

        // L.geoJSON(geojsonFeature).addTo(map);


        var geojsonFeatures = [
            {
                "type": "Feature",
                "properties": {
                    "name": "from",
                    "type": "from",
                    "amenity": "Baseball Stadium",
                    "popupContent": "This is where the Rockies play!"
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                        10.578343,
                        53.079616
                    ]
                }
            },
            {
                "type": "Feature",
                "properties": {
                    "name": "via1",
                    "type": "via"
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                        10.578343,
                        53.079616
                    ]
                }
            },
            {
                "type": "Feature",
                "properties": {
                    "name": "via2",
                    "type": "via"
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                        10.56912660598755,
                        53.08093103740037
                    ]
                }
            },
        ];

        // L.geoJSON(geojsonFeatures).addTo(map);

        // Routenkontroller für die Eingabe von Start- und Endpunkt
        // hier: Startpunkt wird nicht gesetzt, muss vom Anwender eingegeben werden,
        // Endpunkt ist Energie-Museum Berlin.
        // Linieneigenschaften für die Routenlinie samt Alternativrouten.
        // Karte wird auf die gesamte wird auf gesamte Länge der Route gezoomt.
        // Mapbox wir als Router festgelegt (Key erforderlich),
        // Routerprofil: Standard ist das Routen für Autos unter Berücksichtigung der Verkehrssituation (Stauvermeidung),
        // Sprache der Navigationsanweisungen ist Deutsch,

        /*

        var routingcontrol = L.Routing.control(
            {
                waypoints: [L.latLng(), L.latLng(lat, lng)],
                lineOptions: {
                    styles: [
                        { color: 'red', opacity: 1, weight: 5 },
                        { color: 'green', opacity: 1, weight: 5 },
                        { color: 'blue', opacity: 1, weight: 5 }
                    ]
                },
                fitSelectedRoutes: 'true',
                router: L.Routing.mapbox(apiToken,
                    {
                        profile: 'mapbox/driving-traffic', language: 'de', alternatives: 'true'
                    }),
                geocoder: L.Control.Geocoder.nominatim({})
            }
        ).addTo(map);

        // Schaltknöpfe für das Auslösen von Routing-Aktionen 
        // Nach jedem Klick auf die unterschiedlichen Knöpfe wir ein entsprechendes Ereignis ausgelöst.
        // Das Verfahren zum Suchen des Wegs zwischen Start- und Endpunkt wird im Profil des
        // Routenkontrollers geändert. Anschließend wird der Routen-Suchalgorithmus neu angestoßen.

        L.easyButton('fa-walking', function() {
            routingcontrol.getRouter().options.profile = 'mapbox/walking';
            routingcontrol.route();
        }).addTo(map);

        L.easyButton('fa-bicycle', function() {
            routingcontrol.getRouter().options.profile = 'mapbox/cycling';
            routingcontrol.route();
        }).addTo(map);

        L.easyButton('fa-car', function() {
            routingcontrol.getRouter().options.profile = 'mapbox/driving-traffic';
            routingcontrol.route();
        }).addTo(map);

*/

        const all = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "creator": "BRouter-1.7.0",
                        "name": "Bad Bevensen Test (3.9km)",
                        "track-length": "3862",
                        "filtered ascend": "23",
                        "plain-ascend": "4",
                        "total-time": "690",
                        "total-energy": "68881",
                        "cost": "5284",
                        "messages": [
                            [
                                "Longitude",
                                "Latitude",
                                "Elevation",
                                "Distance",
                                "CostPerKm",
                                "ElevCost",
                                "TurnCost",
                                "NodeCost",
                                "InitialCost",
                                "WayTags",
                                "NodeTags",
                                "Time",
                                "Energy"
                            ],
                            [
                                "10578317",
                                "53078952",
                                "35",
                                "74",
                                "1150",
                                "0",
                                "3",
                                "0",
                                "0",
                                "highway=living_street surface=sett cycleway=opposite oneway=yes oneway:bicycle=no",
                                "",
                                "15",
                                "1546"
                            ],
                            [
                                "10576974",
                                "53079408",
                                "36",
                                "103",
                                "1450",
                                "0",
                                "113",
                                "0",
                                "0",
                                "reversedirection=yes highway=tertiary surface=asphalt cycleway:right=lane cycleway:left=no estimated_traffic_class=3",
                                "",
                                "36",
                                "3662"
                            ],
                            [
                                "10576866",
                                "53079472",
                                "36",
                                "10",
                                "1450",
                                "0",
                                "0",
                                "0",
                                "0",
                                "reversedirection=yes highway=tertiary surface=asphalt cycleway:right=lane cycleway:left=no smoothness=good estimated_traffic_class=3",
                                "highway=crossing crossing=uncontrolled",
                                "38",
                                "3850"
                            ],
                            [
                                "10575451",
                                "53080309",
                                "35",
                                "132",
                                "1450",
                                "0",
                                "0",
                                "0",
                                "0",
                                "reversedirection=yes highway=tertiary surface=asphalt cycleway:right=lane cycleway:left=no smoothness=good estimated_traffic_class=3",
                                "",
                                "60",
                                "6065"
                            ],
                            [
                                "10575364",
                                "53080275",
                                "35",
                                "7",
                                "1150",
                                "0",
                                "70",
                                "0",
                                "0",
                                "highway=residential surface=asphalt lcn=yes",
                                "nodeaccessgranted=yes highway=stop direction=backward",
                                "61",
                                "6180"
                            ],
                            [
                                "10571950",
                                "53080096",
                                "38",
                                "238",
                                "1150",
                                "0",
                                "27",
                                "0",
                                "0",
                                "highway=residential surface=asphalt lcn=yes",
                                "",
                                "108",
                                "10891"
                            ],
                            [
                                "10569174",
                                "53080909",
                                "35",
                                "207",
                                "1150",
                                "0",
                                "1",
                                "0",
                                "0",
                                "reversedirection=yes highway=residential oneway=no lcn=yes",
                                "",
                                "140",
                                "14028"
                            ],
                            [
                                "10568690",
                                "53081059",
                                "36",
                                "4",
                                "1150",
                                "0",
                                "0",
                                "0",
                                "0",
                                "reversedirection=yes highway=residential surface=asphalt oneway=no lcn=yes",
                                "",
                                "140",
                                "14090"
                            ],
                            [
                                "10569174",
                                "53080909",
                                "35",
                                "4",
                                "1150",
                                "0",
                                "0",
                                "0",
                                "0",
                                "highway=residential surface=asphalt oneway=no lcn=yes",
                                "",
                                "0",
                                "67"
                            ],
                            [
                                "10570621",
                                "53077284",
                                "44",
                                "378",
                                "1150",
                                "0",
                                "44",
                                "0",
                                "0",
                                "highway=residential surface=asphalt",
                                "",
                                "90",
                                "9079"
                            ],
                            [
                                "10569926",
                                "53078333",
                                "44",
                                "75",
                                "1150",
                                "0",
                                "0",
                                "0",
                                "0",
                                "reversedirection=yes highway=residential surface=asphalt",
                                "",
                                "12",
                                "1260"
                            ],
                            [
                                "10571242",
                                "53076281",
                                "46",
                                "235",
                                "1150",
                                "0",
                                "0",
                                "0",
                                "0",
                                "highway=residential surface=asphalt",
                                "",
                                "46",
                                "4679"
                            ],
                            [
                                "10567713",
                                "53075782",
                                "52",
                                "243",
                                "1150",
                                "0",
                                "100",
                                "0",
                                "0",
                                "reversedirection=yes highway=residential surface=asphalt lcn=yes estimated_noise_class=1",
                                "",
                                "104",
                                "10486"
                            ],
                            [
                                "10565594",
                                "53077643",
                                "53",
                                "259",
                                "1150",
                                "0",
                                "51",
                                "0",
                                "0",
                                "reversedirection=yes highway=residential surface=asphalt",
                                "",
                                "168",
                                "16808"
                            ],
                            [
                                "10565170",
                                "53077595",
                                "53",
                                "2",
                                "1350",
                                "0",
                                "90",
                                "0",
                                "0",
                                "reversedirection=yes highway=service surface=paving_stones",
                                "",
                                "168",
                                "16863"
                            ],
                            [
                                "10565594",
                                "53077643",
                                "53",
                                "2",
                                "1350",
                                "0",
                                "0",
                                "0",
                                "0",
                                "highway=service surface=paving_stones",
                                "",
                                "0",
                                "33"
                            ],
                            [
                                "10564463",
                                "53081279",
                                "43",
                                "414",
                                "1150",
                                "0",
                                "92",
                                "0",
                                "0",
                                "reversedirection=yes highway=residential surface=asphalt",
                                "",
                                "53",
                                "5311"
                            ],
                            [
                                "10567789",
                                "53081216",
                                "37",
                                "217",
                                "1150",
                                "0",
                                "83",
                                "0",
                                "0",
                                "highway=residential surface=asphalt oneway=no lcn=yes",
                                "",
                                "73",
                                "7309"
                            ],
                            [
                                "10569174",
                                "53080909",
                                "35",
                                "106",
                                "1150",
                                "0",
                                "1",
                                "0",
                                "0",
                                "highway=residential surface=asphalt oneway=no lcn=yes",
                                "",
                                "15",
                                "1554"
                            ],
                            [
                                "10571950",
                                "53080096",
                                "38",
                                "207",
                                "1150",
                                "0",
                                "0",
                                "0",
                                "0",
                                "highway=residential oneway=no lcn=yes",
                                "",
                                "55",
                                "5540"
                            ],
                            [
                                "10575364",
                                "53080275",
                                "35",
                                "238",
                                "1150",
                                "0",
                                "28",
                                "0",
                                "0",
                                "reversedirection=yes highway=residential surface=asphalt lcn=yes",
                                "nodeaccessgranted=yes highway=stop direction=backward",
                                "91",
                                "9104"
                            ],
                            [
                                "10575451",
                                "53080309",
                                "35",
                                "7",
                                "1150",
                                "0",
                                "0",
                                "0",
                                "0",
                                "reversedirection=yes highway=residential surface=asphalt lcn=yes",
                                "",
                                "92",
                                "9204"
                            ],
                            [
                                "10575266",
                                "53080418",
                                "35",
                                "17",
                                "1050",
                                "0",
                                "109",
                                "0",
                                "0",
                                "reversedirection=yes highway=tertiary lcn=yes estimated_traffic_class=3",
                                "nodeaccessgranted=yes highway=crossing crossing=uncontrolled",
                                "94",
                                "9438"
                            ],
                            [
                                "10574841",
                                "53080669",
                                "34",
                                "29",
                                "1050",
                                "0",
                                "0",
                                "0",
                                "0",
                                "reversedirection=yes highway=tertiary lcn=yes estimated_traffic_class=3",
                                "",
                                "97",
                                "9797"
                            ],
                            [
                                "10574000",
                                "53081164",
                                "33",
                                "90",
                                "1050",
                                "0",
                                "0",
                                "0",
                                "0",
                                "reversedirection=yes highway=tertiary lcn=yes estimated_traffic_class=3",
                                "",
                                "12",
                                "1297"
                            ],
                            [
                                "10569463",
                                "53083602",
                                "32",
                                "418",
                                "1050",
                                "0",
                                "9",
                                "0",
                                "0",
                                "highway=tertiary lcn=yes estimated_traffic_class=3",
                                "",
                                "76",
                                "7639"
                            ],
                            [
                                "10569243",
                                "53083545",
                                "31",
                                "16",
                                "1050",
                                "0",
                                "2",
                                "0",
                                "0",
                                "highway=tertiary surface=asphalt lcn=yes estimated_traffic_class=2",
                                "",
                                "78",
                                "7882"
                            ],
                            [
                                "10567283",
                                "53084012",
                                "35",
                                "130",
                                "1050",
                                "0",
                                "13",
                                "0",
                                "0",
                                "highway=tertiary surface=asphalt lcn=yes estimated_traffic_class=2 estimated_forest_class=2",
                                "",
                                "104",
                                "10483"
                            ]
                        ]
                    },
                    "geometry": {
                        "type": "LineString",
                        "coordinates": [
                            [
                                10.578341,
                                53.079615,
                                34.25
                            ],
                            [
                                10.578358,
                                53.079056,
                                35.25
                            ],
                            [
                                10.578317,
                                53.078952,
                                35.75
                            ],
                            [
                                10.57817,
                                53.078998,
                                35.75
                            ],
                            [
                                10.577115,
                                53.079343,
                                36
                            ],
                            [
                                10.576974,
                                53.079408,
                                36
                            ],
                            [
                                10.576866,
                                53.079472,
                                36
                            ],
                            [
                                10.576475,
                                53.079698,
                                35.75
                            ],
                            [
                                10.576072,
                                53.079942,
                                35.75
                            ],
                            [
                                10.575664,
                                53.080183,
                                35.5
                            ],
                            [
                                10.575451,
                                53.080309,
                                35.5
                            ],
                            [
                                10.575364,
                                53.080275,
                                35.5
                            ],
                            [
                                10.5753,
                                53.08025,
                                35.75
                            ],
                            [
                                10.575163,
                                53.080235,
                                36
                            ],
                            [
                                10.574513,
                                53.080233,
                                36
                            ],
                            [
                                10.574188,
                                53.080243,
                                36
                            ],
                            [
                                10.573885,
                                53.080294,
                                35.75
                            ],
                            [
                                10.573792,
                                53.080313,
                                35.75
                            ],
                            [
                                10.573685,
                                53.080321,
                                35.75
                            ],
                            [
                                10.573548,
                                53.080319,
                                35.75
                            ],
                            [
                                10.573419,
                                53.080306,
                                35.75
                            ],
                            [
                                10.573155,
                                53.080256,
                                36.25
                            ],
                            [
                                10.572568,
                                53.08013,
                                37.25
                            ],
                            [
                                10.57236,
                                53.080086,
                                37.75
                            ],
                            [
                                10.572143,
                                53.080059,
                                38
                            ],
                            [
                                10.57195,
                                53.080096,
                                38
                            ],
                            [
                                10.570851,
                                53.080422,
                                36.75
                            ],
                            [
                                10.569938,
                                53.080687,
                                35.75
                            ],
                            [
                                10.569226,
                                53.080894,
                                35.75
                            ],
                            [
                                10.569174,
                                53.080909,
                                35.75
                            ],
                            [
                                10.569121,
                                53.080925,
                                36.25
                            ],
                            [
                                10.569174,
                                53.080909,
                                35.75
                            ],
                            [
                                10.569197,
                                53.080741,
                                36
                            ],
                            [
                                10.569253,
                                53.080412,
                                37
                            ],
                            [
                                10.569399,
                                53.079555,
                                40.25
                            ],
                            [
                                10.56945,
                                53.079178,
                                41.75
                            ],
                            [
                                10.569463,
                                53.079089,
                                42
                            ],
                            [
                                10.56957,
                                53.078901,
                                42.75
                            ],
                            [
                                10.569926,
                                53.078333,
                                44
                            ],
                            [
                                10.570342,
                                53.077703,
                                44
                            ],
                            [
                                10.570392,
                                53.077627,
                                44.5
                            ],
                            [
                                10.570342,
                                53.077703,
                                44
                            ],
                            [
                                10.569978,
                                53.078253,
                                44
                            ],
                            [
                                10.570342,
                                53.077703,
                                44
                            ],
                            [
                                10.570621,
                                53.077284,
                                44.5
                            ],
                            [
                                10.571016,
                                53.076659,
                                45.75
                            ],
                            [
                                10.571242,
                                53.076281,
                                46
                            ],
                            [
                                10.569772,
                                53.076073,
                                49.25
                            ],
                            [
                                10.569414,
                                53.076024,
                                50
                            ],
                            [
                                10.568568,
                                53.075903,
                                51.5
                            ],
                            [
                                10.567713,
                                53.075782,
                                52.75
                            ],
                            [
                                10.567503,
                                53.075886,
                                52.75
                            ],
                            [
                                10.567413,
                                53.075945,
                                53
                            ],
                            [
                                10.567335,
                                53.075997,
                                53
                            ],
                            [
                                10.567189,
                                53.076102,
                                53
                            ],
                            [
                                10.566896,
                                53.076316,
                                53.75
                            ],
                            [
                                10.566885,
                                53.07633,
                                53.75
                            ],
                            [
                                10.566814,
                                53.076418,
                                54
                            ],
                            [
                                10.566561,
                                53.076595,
                                54.5
                            ],
                            [
                                10.566452,
                                53.076643,
                                54.5
                            ],
                            [
                                10.565974,
                                53.076985,
                                54
                            ],
                            [
                                10.565792,
                                53.077115,
                                54
                            ],
                            [
                                10.565765,
                                53.077155,
                                54
                            ],
                            [
                                10.565723,
                                53.077216,
                                54
                            ],
                            [
                                10.565716,
                                53.07724,
                                54
                            ],
                            [
                                10.565594,
                                53.077643,
                                53.5
                            ],
                            [
                                10.565564,
                                53.077639,
                                53.75
                            ],
                            [
                                10.565594,
                                53.077643,
                                53.5
                            ],
                            [
                                10.565523,
                                53.07788,
                                52.75
                            ],
                            [
                                10.565419,
                                53.078203,
                                52.25
                            ],
                            [
                                10.565337,
                                53.078455,
                                51.5
                            ],
                            [
                                10.565234,
                                53.078772,
                                50.5
                            ],
                            [
                                10.565022,
                                53.079414,
                                48.5
                            ],
                            [
                                10.564845,
                                53.079958,
                                46.75
                            ],
                            [
                                10.564801,
                                53.0801,
                                46.5
                            ],
                            [
                                10.564736,
                                53.080311,
                                46.25
                            ],
                            [
                                10.564702,
                                53.080422,
                                46.25
                            ],
                            [
                                10.564568,
                                53.080861,
                                45.75
                            ],
                            [
                                10.564456,
                                53.081224,
                                43.75
                            ],
                            [
                                10.564463,
                                53.081279,
                                43.5
                            ],
                            [
                                10.566514,
                                53.081291,
                                38.5
                            ],
                            [
                                10.566721,
                                53.081288,
                                38.25
                            ],
                            [
                                10.56692,
                                53.081286,
                                38
                            ],
                            [
                                10.567395,
                                53.081266,
                                37.5
                            ],
                            [
                                10.567685,
                                53.081229,
                                37
                            ],
                            [
                                10.567789,
                                53.081216,
                                37
                            ],
                            [
                                10.568135,
                                53.081165,
                                36.75
                            ],
                            [
                                10.56869,
                                53.081059,
                                36.25
                            ],
                            [
                                10.569174,
                                53.080909,
                                35.75
                            ],
                            [
                                10.569226,
                                53.080894,
                                35.75
                            ],
                            [
                                10.569938,
                                53.080687,
                                35.75
                            ],
                            [
                                10.570851,
                                53.080422,
                                36.75
                            ],
                            [
                                10.57195,
                                53.080096,
                                38
                            ],
                            [
                                10.572143,
                                53.080059,
                                38
                            ],
                            [
                                10.57236,
                                53.080086,
                                37.75
                            ],
                            [
                                10.572568,
                                53.08013,
                                37.25
                            ],
                            [
                                10.573155,
                                53.080256,
                                36.25
                            ],
                            [
                                10.573419,
                                53.080306,
                                35.75
                            ],
                            [
                                10.573548,
                                53.080319,
                                35.75
                            ],
                            [
                                10.573685,
                                53.080321,
                                35.75
                            ],
                            [
                                10.573792,
                                53.080313,
                                35.75
                            ],
                            [
                                10.573885,
                                53.080294,
                                35.75
                            ],
                            [
                                10.574188,
                                53.080243,
                                36
                            ],
                            [
                                10.574513,
                                53.080233,
                                36
                            ],
                            [
                                10.575163,
                                53.080235,
                                36
                            ],
                            [
                                10.5753,
                                53.08025,
                                35.75
                            ],
                            [
                                10.575364,
                                53.080275,
                                35.5
                            ],
                            [
                                10.575451,
                                53.080309,
                                35.5
                            ],
                            [
                                10.575266,
                                53.080418,
                                35.25
                            ],
                            [
                                10.574954,
                                53.080602,
                                34.5
                            ],
                            [
                                10.574841,
                                53.080669,
                                34.5
                            ],
                            [
                                10.574,
                                53.081164,
                                33.5
                            ],
                            [
                                10.573348,
                                53.081537,
                                33
                            ],
                            [
                                10.571038,
                                53.082875,
                                31.75
                            ],
                            [
                                10.57061,
                                53.083187,
                                32
                            ],
                            [
                                10.570453,
                                53.083335,
                                32.25
                            ],
                            [
                                10.570366,
                                53.083408,
                                32.5
                            ],
                            [
                                10.570224,
                                53.083496,
                                32.5
                            ],
                            [
                                10.570115,
                                53.083535,
                                32.5
                            ],
                            [
                                10.569974,
                                53.083566,
                                32.5
                            ],
                            [
                                10.569773,
                                53.083599,
                                32.25
                            ],
                            [
                                10.569592,
                                53.083615,
                                32
                            ],
                            [
                                10.569463,
                                53.083602,
                                32
                            ],
                            [
                                10.569243,
                                53.083545,
                                31.75
                            ],
                            [
                                10.569135,
                                53.083536,
                                31.75
                            ],
                            [
                                10.569078,
                                53.083539,
                                31.75
                            ],
                            [
                                10.568967,
                                53.083555,
                                31.5
                            ],
                            [
                                10.568849,
                                53.083595,
                                31.5
                            ],
                            [
                                10.568647,
                                53.083711,
                                31.5
                            ],
                            [
                                10.568528,
                                53.083765,
                                31.25
                            ],
                            [
                                10.568356,
                                53.083818,
                                31.25
                            ],
                            [
                                10.56765,
                                53.083949,
                                33.75
                            ],
                            [
                                10.56751,
                                53.083972,
                                35.5
                            ]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "from",
                        "type": "from"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            10.578343,
                            53.079616
                        ]
                    }
                },
                // {
                //     "type": "Feature",
                //     "properties": {
                //         "name": "via1",
                //         "type": "via"
                //     },
                //     "geometry": {
                //         "type": "Point",
                //         "coordinates": [
                //             10.578343,
                //             53.079616
                //         ]
                //     }
                // },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "via2",
                        "type": "via"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            10.56912660598755,
                            53.08093103740037
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "via3",
                        "type": "via"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            10.570393,
                            53.077628
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "via4",
                        "type": "via"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            10.569963455200197,
                            53.078249560223135
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "via5",
                        "type": "via"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            10.565565,
                            53.077641
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "via6",
                        "type": "via"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            10.565565,
                            53.077641
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "via7",
                        "type": "via"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            10.567688941955568,
                            53.08123889487676
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "via8",
                        "type": "via"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            10.567688941955568,
                            53.08123889487676
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "via9",
                        "type": "via"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            10.575006008148193,
                            53.080634074229614
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "via10",
                        "type": "via"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            10.567517280578615,
                            53.0839858093095
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "to",
                        "type": "to"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            10.567517280578615,
                            53.0839858093095
                        ]
                    }
                }
            ]
        };
        L.geoJSON(all).addTo(map);
    </script>
    <script>
        // MQTT - our sample broker is running on localhost:9001
        const MQTTBROKERURL = 'ws://tiptronic.synology.me:9001';
        // we subscribe to all topics starting with 'mqtt/' (could be anything)
        const MQTTSUBSCRIPTION = 'owntracks/user/iphone13';
        class SampleAction {
            constructor () {
                this.mqttClient = null;
                this.init();
            }

            init() {
                const options = {
                    reconnectPeriod: 1000 * 60, // every minute
                    // clean: false,
                    clientId: 'synology-client-' +  parseInt(Math.random() * 100,10)
                };
                this.mqttClient = mqtt.connect(MQTTBROKERURL, options);
                this.mqttClient.subscribe(MQTTSUBSCRIPTION);
                // this.statusTextArr.push('Connection::', MQTTBROKERURL, 'Subscription:', MQTTSUBSCRIPTION);
                console.log('Connection::', MQTTBROKERURL, 'Subscription:', MQTTSUBSCRIPTION, 'clientId:', options.clientId);

                this.mqttClient.on("message", (topic, payload) => {
                    // console.log('rcvd', [topic, payload].join(": "));
                    console.log('rcvd', topic, payload);
                    const message = payload.toString();


                    try {
                        const obj = JSON.parse(message);
                        console.log(obj);
                        if(topic === 'owntracks/user/iphone13') {
                            if(obj.lat != undefined && obj.lon != undefined) {
                                // const theMarker = L.marker([obj.latitude, obj.longitude]).addTo(map);
                                // theMarker.bindPopup(obj.name).openPopup();
                                if(theMarker != undefined) {
                                    map.removeLayer(theMarker);
                                };

                                //Add a marker to show where you clicked.
                                theMarker = L.marker([ obj.lat, obj.lon ], {icon: busIcon}).addTo(map);
                            }


                        }
                    } catch(e) {
                        console.log(e);
                        console.log(message);

                    }
                });

                // this.mqttClient.publish("mqtt/demo", "Hello Plugin!");
                // for(let i = 0;i < 20;i++) {
                //     if(i % 2 === 0) {
                //         this.mqttClient.publish("mqtt/a", randomDate());
                //     } else {
                //         this.mqttClient.publish("mqtt/b", new Date().toLocaleTimeString());
                //     }
                // };
            }
        };


        const action = new SampleAction();
        window.action = action;
    </script>
</body>

</html>